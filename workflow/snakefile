rule all:
    input:        
        "sorted/RV417026_S15_L001.mpileup.gz"


rule fastp:
    input:
        "original_fastq/FastqExamples/RV417026_S15_L001_R1_001.fastq",
        "original_fastq/FastqExamples/RV417026_S15_L001_R2_001.fastq"
    output:
        "filrered_result/RV417026_S15_L001_R1_001.cleaned.fastq",
        "filrered_result/RV417026_S15_L001_R2_001.cleaned.fastq"
    conda:
        "envs/mapping.yaml"
    shell:
        "fastp -i {input[0]} -o {output[0]} -I {input[1]} -O {output[1]} -q 20 -c -y -l 50 -g -p -f 10 -n 5 --adapter_sequence GCGAATTTCGACGATCGTTGCATTAACTCGCGAA --adapter_sequence_r2 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT"


rule bwa_mem:
    input:
        "filrered_result/RV417026_S15_L001_R1_001.cleaned.fastq",
        "filrered_result/RV417026_S15_L001_R2_001.cleaned.fastq",
        "workflow/ref.fasta"
    output:
        "mapped/RV417026_S15_L001.bam",
        multiext("midresult/ref", ".amb", ".ann", ".bwt", ".pac", ".sa")
    conda:
        "envs/mapping.yaml"
    shell:
        "bwa index {input[2]} -p midresult/ref;"
        "bwa mem -p midresult/ref {input[0]} {input[1]} -o {output[0]}"

rule sam_view:
    input:
        "mapped/RV417026_S15_L001.bam"
    output:
        "mapped/RV417026_S15_L001_1.bam"
    conda:
        "envs/mapping.yaml"
    shell:
        "samtools view -b {input} -o {output}"
    
rule sam_sort:
    input:
        "mapped/RV417026_S15_L001_1.bam"
    output:
        "sorted/RV417026_S15_L001.bam"
    conda:
        "envs/mapping.yaml"
    shell:
        "samtools sort {input} -o {output}"

rule sam_index:
    input:
        "sorted/RV417026_S15_L001.bam"
    output:
        "sorted/RV417026_S15_L001.bam.bai"
    conda:
        "envs/mapping.yaml"
    shell:
        "samtools sort {input} -o {output}"

rule mpilup:
    input:
        # single or list of bam files
        bam="sorted/RV417026_S15_L001.bam",
        reference_genome="workflow/ref.fasta",
    output:
        "sorted/RV417026_S15_L001.mpileup.gz",
    log:
        "logs/samtools/mpileup/RV417026_S15_L001.log",
    params:
        extra="-d 10000",  # optional
    wrapper:
        "v1.22.0/bio/samtools/mpileup"

    
